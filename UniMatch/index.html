<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UniMatch AI Chatbot</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin:0; padding:0; }
body {
  font-family: 'Inter', sans-serif;
  background: url('C:/Users/DELL/Desktop/UniMatch_AI/632ec16b-714f-4780-a6e6-1af923edc541.png') no-repeat center center fixed;
  background-size: cover;
  display: flex; justify-content:center; align-items:center; height:100vh; padding:10px;
}

#main-container { display:flex; width:100%; max-width:900px; height:90vh; border-radius:20px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.3); }

#sidebar { width:30%; background:#2575fc; color:#fff; display:flex; flex-direction:column; padding:15px; overflow-y:auto; }
#sidebar h2 { font-weight:600; margin-bottom:10px; font-size:18px; }
#new-chat-btn { background:#fff; color:#2575fc; border:none; padding:8px 12px; margin-bottom:10px; border-radius:12px; cursor:pointer; font-weight:600; transition:0.2s; }
#new-chat-btn:hover { background:#e0e0e0; }

.chat-item { background: rgba(255,255,255,0.2); padding: 10px 12px; margin-bottom:10px; border-radius:12px; cursor:pointer; position: relative; transition:0.2s; }
.chat-item:hover { background: rgba(255,255,255,0.35); }

.chat-item .more-btn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  display: none;
  background: transparent;
  border: none;
  font-weight: bold;
  font-size: 18px;
  cursor: pointer;
  color: #fff;
}
.chat-item:hover .more-btn { display: block; }

#chat-container { flex:1; display:flex; flex-direction:column; background: rgba(255,255,255,0.95); border-radius:20px; }
#chat { flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column; gap:14px; min-height:0; }
.message { padding:12px 20px; border-radius:25px; max-width:75%; font-size:15px; line-height:1.4; word-wrap:break-word; opacity:0; transform:translateY(20px); animation:fadeIn 0.3s forwards; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
.user { align-self:flex-end; background:#2575fc; color:#fff; border-bottom-right-radius:0; }
.bot { align-self:flex-start; background:#e0e0e0; color:#333; border-bottom-left-radius:0; }
.bot b { color:#2575fc; }
@keyframes fadeIn { to { opacity:1; transform:translateY(0); } }

#input-container { display:flex; padding:15px; border-top:1px solid #ccc; background:#fafafa; align-items:center; }
#user-input { flex:1; padding:14px 18px; border:none; outline:none; border-radius:50px; margin-right:12px; background:#f0f0f0; }
#user-input:focus { background:#e2e2e2; }
#send-btn { background:#2575fc; color:#fff; border:none; padding:12px 20px; border-radius:50px; cursor:pointer; transition:0.2s; }
#send-btn:hover { background:#6a11cb; }

.typing { display:inline-block; width:60px; text-align:left; }
.typing span { display:inline-block;width:8px;height:8px;margin-right:4px;background:#ccc;border-radius:50%;animation:blink 1.4s infinite both;}
.typing span:nth-child(2){animation-delay:0.2s;} 
.typing span:nth-child(3){animation-delay:0.4s;}
@keyframes blink {0%,80%,100%{opacity:0;}40%{opacity:1;}}

#chat::-webkit-scrollbar, #sidebar::-webkit-scrollbar { width:6px; }
#chat::-webkit-scrollbar-thumb, #sidebar::-webkit-scrollbar-thumb { background:#2575fc; border-radius:3px; }
#chat::-webkit-scrollbar-track, #sidebar::-webkit-scrollbar-track { background:#f1f1f1; }

@media(max-width:700px){
  #main-container { flex-direction:column; height:95vh; }
  #sidebar { width:100%; height:120px; flex-direction:row; overflow-x:auto; }
  #chat-container { flex:1; }
}
</style>
</head>
<body>

<div id="main-container">
  <div id="sidebar">
    <h2>Chats</h2>
    <button id="new-chat-btn">+ New Chat</button>
    <div id="chat-list"></div>
  </div>
  <div id="chat-container">
    <div id="chat"></div>
    <div id="input-container">
      <input type="text" id="user-input" placeholder="Enter your interests, marks, and city..." />
      <button id="send-btn">Send</button>
    </div>
  </div>
</div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("user-input");
const sendBtn = document.getElementById("send-btn");
const chatList = document.getElementById("chat-list");
const newChatBtn = document.getElementById("new-chat-btn");

let chats = JSON.parse(localStorage.getItem("chats") || "[]");
let currentChatIndex = chats.length ? chats.length - 1 : 0;

function renderSidebar() {
  chatList.innerHTML = "";
  // reverse loop to show latest chat on top
  chats.slice().reverse().forEach((session, reverseIdx) => {
    const idx = chats.length - 1 - reverseIdx; // original index
    if (!session.length) return;
    const lastMsg = session[session.length - 1].message || "New Chat";
    const chatItem = document.createElement("div");
    chatItem.classList.add("chat-item");
    chatItem.textContent = lastMsg.slice(0, 30) + "...";

    const moreBtn = document.createElement("button");
    moreBtn.classList.add("more-btn");
    moreBtn.textContent = "âœ–"; // new
    moreBtn.addEventListener("click", e => {
      e.stopPropagation();
      if (confirm("Are you sure you want to delete this chat?")) {
        chats.splice(idx, 1);
        saveChats();
        if (currentChatIndex === idx) chat.innerHTML = "";
      }
    });

    chatItem.appendChild(moreBtn);

    chatItem.dataset.index = idx;
    chatItem.addEventListener("click", () => {
      currentChatIndex = idx;
      loadChat(idx);
    });
    chatList.appendChild(chatItem);
  });
}

function loadChat(index) {
  chat.innerHTML = "";
  chats[index].forEach(msg => appendMessage(msg.message, msg.type));
}

function saveChats() {
  localStorage.setItem("chats", JSON.stringify(chats));
  renderSidebar();
}

function appendMessage(message, type) {
  const msgDiv = document.createElement("div");
  msgDiv.classList.add("message", type);

  if (type === "bot") {
    msgDiv.innerHTML = formatBotReply(message);
  } else {
    msgDiv.textContent = message;
  }

  chat.appendChild(msgDiv);
  chat.scrollTop = chat.scrollHeight;
}

function formatBotReply(reply) {
  return reply
    .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")      // bold
    .replace(/- (.*?)(\n|$)/g, "â€¢ $1<br>")       // bullets
    .replace(/\n/g, "<br>");                     // line breaks
}

function showTyping() {
  const typingDiv = document.createElement("div");
  typingDiv.classList.add("message", "bot");
  typingDiv.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';
  chat.appendChild(typingDiv);
  chat.scrollTop = chat.scrollHeight;
  return typingDiv;
}

async function sendMessage() {
  const userMessage = input.value.trim();
  if (!userMessage) return;

  if (!chats[currentChatIndex]) chats[currentChatIndex] = [];
  chats[currentChatIndex].push({ message: userMessage, type: "user" });
  appendMessage(userMessage, "user");
  input.value = "";
  saveChats();

  const typingDiv = showTyping();

  try {
    const history = chats[currentChatIndex].map(msg => ({
      role: msg.type === "user" ? "user" : "assistant",
      content: msg.message
    }));

    const response = await fetch("http://localhost:5000/chat", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ history })
});


    const data = await response.json();
    typingDiv.remove();

    if (data.reply) {
      appendMessage(data.reply, "bot");
      chats[currentChatIndex].push({ message: data.reply, type: "bot" });
      saveChats();
    } else {
      appendMessage("Sorry, no response from server.", "bot");
    }

  } catch (err) {
    console.error(err);
    typingDiv.remove();
    appendMessage("Sorry, server is not responding. Try again later.", "bot");
  }
}

sendBtn.addEventListener("click", sendMessage);
input.addEventListener("keypress", e => { if (e.key === "Enter") sendMessage(); });

newChatBtn.addEventListener("click", () => {
  chats.push([]);
  currentChatIndex = chats.length - 1;
  chat.innerHTML = "";
  appendMessage(
    "ðŸ‘‹ Hello! I am UniMatch AI. Tell me your interests, marks, and city, and I will suggest the best fields and universities for you.",
    "bot"
  );
  saveChats();
});

// Initial load
if (!chats.length) {
  chats.push([]);
  currentChatIndex = 0;
  appendMessage(
    "ðŸ‘‹ Hello! I am UniMatch AI. Tell me your interests, marks, and city, and I will suggest the best fields and universities for you.",
    "bot"
  );
  saveChats();
} else {
  renderSidebar();
  loadChat(currentChatIndex);
}
</script>

</body>
</html>
